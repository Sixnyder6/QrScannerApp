name: Android CI/CD Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew assembleRelease

      - name: Create Advanced update.json
        run: |
          # Читаем versionCode и versionName из build.gradle.kts
          VERSION_CODE=$(grep -o 'versionCode = [0-9]*' app/build.gradle.kts | awk '{print $3}')
          VERSION_NAME=$(grep -o 'versionName = "[^"]*"' app/build.gradle.kts | sed 's/versionName = "//;s/"//')

          # Формируем URL для APK
          APK_URL="https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/app-release.apk"

          # Формируем URLы для картинок (если они есть)
          IMAGE_URLS=""
          if ls release-assets/image*.png 1> /dev/null 2>&1; then
            for img in release-assets/image*.png; do
              FILENAME=$(basename "$img")
              IMAGE_URL="https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/$FILENAME"
              if [ -z "$IMAGE_URLS" ]; then
                IMAGE_URLS="\"$IMAGE_URL\""
              else
                IMAGE_URLS="$IMAGE_URLS, \"$IMAGE_URL\""
              fi
            done
          fi

          # Читаем кастомные поля из release_notes.json
          APK_SIZE=$(jq -r '.apkSize' release-assets/release_notes.json)
          RELEASE_ITEMS=$(jq -c '.releaseItems' release-assets/release_notes.json)

          # Собираем финальный JSON
          echo "{" > app/build/outputs/apk/release/update.json
          echo "  \"latestVersionCode\": $VERSION_CODE," >> app/build/outputs/apk/release/update.json
          echo "  \"latestVersionName\": \"$VERSION_NAME\"," >> app/build/outputs/apk/release/update.json
          echo "  \"apkUrl\": \"$APK_URL\"," >> app/build/outputs/apk/release/update.json
          echo "  \"apkSize\": \"$APK_SIZE\"," >> app/build/outputs/apk/release/update.json
          echo "  \"imageUrls\": [$IMAGE_URLS]," >> app/build/outputs/apk/release/update.json
          echo "  \"releaseItems\": $RELEASE_ITEMS" >> app/build/outputs/apk/release/update.json
          echo "}" >> app/build/outputs/apk/release/update.json

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GH_TOKEN }}
          # Теперь загружаем APK, JSON и все картинки
          files: |
            app/build/outputs/apk/release/app-release.apk
            app/build/outputs/apk/release/update.json
            release-assets/image*.png